unit Unit1;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  StdCtrls, Db, DBCtrls, Grids, DBGrids, DBTables, Mask, ExtCtrls, Buttons, FileCtrl;

type
  TForm1 = class(TForm)
    Button29: TButton;
    Label4: TLabel;
    ListBoxA: TListBox;
    Label13: TLabel;
    Panel2: TPanel;
    TagFilter: TListBox;
    CheckBox1: TCheckBox;
    CheckBox2: TCheckBox;
    Timer1: TTimer;
    Panel3: TPanel;
    Label10: TLabel;
    Label11: TLabel;
    Label12: TLabel;
    DBGrid1: TDBGrid;
    DBMemo1: TDBMemo;
    Button1: TButton;
    Button2: TButton;
    Button3: TButton;
    Button4: TButton;
    Button5: TButton;
    Button6: TButton;
    Button7: TButton;
    Button8: TButton;
    Button9: TButton;
    Button10: TButton;
    Button11: TButton;
    Button12: TButton;
    Button13: TButton;
    Button14: TButton;
    Button15: TButton;
    Button16: TButton;
    Button17: TButton;
    Button18: TButton;
    Button19: TButton;
    Button20: TButton;
    Button21: TButton;
    Button22: TButton;
    Button23: TButton;
    Button24: TButton;
    Button25: TButton;
    Button26: TButton;
    Button27: TButton;
    Panel1: TPanel;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Label9: TLabel;
    Label8: TLabel;
    DBEdit1: TDBEdit;
    DBEdit2: TDBEdit;
    DBEdit3: TDBEdit;
    DBEdit4: TDBEdit;
    DBEdit5: TDBEdit;
    DBEdit6: TDBEdit;
    DBEdit7: TDBEdit;
    DBEdit8: TDBEdit;
    DBEdit9: TDBEdit;
    Button28: TButton;
    ListBoxB: TListBox;
    Button30: TButton;
    StringGrid1: TStringGrid;
    Button31: TButton;
    PB: TTable;
    PBIndex: TAutoIncField;
    PBFirst: TStringField;
    PBName: TStringField;
    PBPhone: TStringField;
    PBPrefix: TStringField;
    PBNotes: TMemoField;
    PBAddress1: TStringField;
    PBAddress2: TStringField;
    PBCity: TStringField;
    PBState: TStringField;
    PBZip: TStringField;
    PBCountry: TStringField;
    PBEmail: TStringField;
    DataSource1: TDataSource;
    SpeedButton1: TSpeedButton;
    SpeedButton2: TSpeedButton;
    Button32: TButton;
    procedure Button1Click(Sender: TObject);
    procedure Button27Click(Sender: TObject);
    procedure Button28Click(Sender: TObject);
    procedure DBGrid1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure ListBoxBMouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure DBGrid1CellClick(Column: TColumn);
    procedure md2(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure ListBoxBDrawItem(Control: TWinControl; Index: Integer;
      Rect: TRect; State: TOwnerDrawState);
    procedure FormActivate(Sender: TObject);
    procedure FilterMouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
    procedure FilterDrawItem(Control: TWinControl; Index: Integer;
      Rect: TRect; State: TOwnerDrawState);
    procedure PBFilterRecord(DataSet: TDataSet; var Accept: Boolean);
    procedure CheckBox2Click(Sender: TObject);
    procedure Button30Click(Sender: TObject);
    procedure Button31Click(Sender: TObject);
    procedure PBAfterScroll(DataSet: TDataSet);
    procedure SpeedButton1Click(Sender: TObject);
    procedure SpeedButton2Click(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
    procedure PBBeforePost(DataSet: TDataSet);
    procedure Button32Click(Sender: TObject);
    procedure BackupDatabase;
  private

    { Private declarations }
  public

    { Public declarations }
  end;

var
  Form1: TForm1;
  GlobalFilter:  string;
  FirstDraw:  boolean;
  FirstDrawCount:  integer;

implementation

{$R *.DFM}

procedure TForm1.Button1Click(Sender: TObject);
var
filter:  string;
begin
filter := 'Name = '+'''' + TButton(Sender).caption + '*'+'''';
//if checkbox1.checked = true then filter := filter + ' AND Country = '+''''+'O*'+'''';
PB.filter := filter;
PB.refresh;
   listboxB.refresh;
   listboxA.refresh;
   TagFilter.refresh;
end;

procedure TForm1.Button27Click(Sender: TObject);
begin
PB.filter := '';
end;

procedure TForm1.Button28Click(Sender: TObject);
begin
PB.INSERT;
DBEdit8.text := 'OXOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO';
ListboxB.Refresh;
end;

procedure TForm1.DBGrid1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
var
L, TagOrder:  integer;
Tag, Flag:  string;
Column:  TColumn;
begin

// HIGHLIGH TAGS IN LISTBOXB
// Note:  listboxA is the Tag Order
Tag := DBEdit8.text;
for L := 1 to 50 do
   begin
   TagOrder := strtoint(listboxA.items[L-1])-1;
   flag := copy(Tag, L, 1);
   if flag = 'X' then listboxB.selected[TagOrder] := true else
      listboxB.selected[TagOrder] := false;
   end;
   listboxB.refresh;
   listboxA.refresh;
end;

procedure TForm1.ListBoxBMouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
var
sel, L, Order:  integer;
Tag, NewTag:  string;

begin
// Set Tag
sel := listboxB.itemindex;
Tag := DBEdit8.text;
label4.caption := inttostr(sel+1);
listboxB.selected[sel] := false;

if ListBoxB.items[sel] = '-' then exit;  // No label for this tag - dont select
Order := strtoint(ListBoxA.items[sel])-1;

if copy(Tag, order+1, 1) = 'X' then
   begin
   Insert('O', Tag, order+1);
   Delete(tag,order+2,1);
   end
      else
          begin
          Insert('X', Tag, order+1);
          Delete(Tag,order+2,1);
          end;


PB.edit;
DBEdit8.text := Tag;
PB.post;

Label10.caption := copy(Tag, sel+1, 1);

DBGrid1.setfocus;
end;


procedure TForm1.DBGrid1CellClick(Column: TColumn);
var
L:  integer;
Tag, Flag:  string;
shift:  TShiftState;
Key:  word;
begin
DBGrid1KeyDown(column, Key, shift);
end;

procedure TForm1.md2(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
label4.caption := inttostr(listboxB.itemindex+1);
end;

procedure TForm1.ListBoxBDrawItem(Control: TWinControl; Index: Integer;
  Rect: TRect; State: TOwnerDrawState);

var
	Bitmap: TBitmap;      { temporary variable for the item’s bitmap }
	Offset: Integer;      { text offset width }
Tag, Indicator:  String;
X,Y:  integer;
begin
Tag := DBEdit8.text;


//Control.brush.color := clBlue;

	with (Control as TListBox).Canvas do  { draw on control canvas, not on the form }
	begin
        Brush.Color := clWhite;
        Font.Color := clBlack;
        //if copy(Tag, Index+1, 1) = 'X' then Font.Color := clBlue;
        X := strtoint(listboxA.items[index]);
        Indicator := copy(Tag, X, 1);

        if (Indicator = 'X') then Font.Color := clBlue;  // test line - revert to above if not working

        FillRect(Rect);       { clear the rectangle }
	Offset := 2;          { provide default offset }
	Bitmap := TBitmap((Control as TListBox).Items.Objects[Index]);  { get the bitmap }

if Bitmap <> nil then
	begin
		BrushCopy(Bounds(Rect.Left + 2, Rect.Top, Bitmap.Width, Bitmap.Height),
			Bitmap, Bounds(0, 0, Bitmap.Width, Bitmap.Height), clRed);  {render bitmap}
		Offset := Bitmap.width + 6;    { add four pixels between bitmap and text}
	end;
	TextOut(Rect.Left + Offset, Rect.Top, (Control as TListBox).Items[Index])  { display the text }
	end;
end;




procedure TForm1.FormActivate(Sender: TObject);
var
x:  integer;
button:  Tmousebutton;
Shift:  TShiftState;
filter:  string;

begin
FirstDraw := true;
FirstDrawCount := 0;
GlobalFilter := 'OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO';
Form1.width := 990;
PB.edit;
ListboxB.items.LoadFromFile('tags.txt');
ListboxA.items.LoadFromFile('tagorder.txt');
TagFilter.items := ListboxB.Items;

// SET FORM1 SIZE
   Panel2.visible := true;
   Panel3.left := 5;
   Button32.caption := 'Show Tags';
   Form1.width := 640;

//filtermousedown(sender, Button, Shift,0,0);
for x := 0 to 49 do TagFilter.selected[x] := false;
TagFilter.refresh;

filter := 'Name = '+'''' + 'A' + '*'+'''';
//if checkbox1.checked = true then filter := filter + ' AND Country = '+''''+'O*'+'''';
PB.filter := filter;
PB.refresh;
   listboxB.refresh;
   listboxA.refresh;
   TagFilter.refresh;




end;

procedure TForm1.FilterMouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
var
sel, L, Order:  integer;
Tag, NewTag:  string;

begin
// FLIP TAGFILTER SELECTED ITEMS
sel := TagFilter.itemindex;
Tag := GlobalFilter;
label4.caption := inttostr(sel+1);
TagFilter.selected[sel] := false;
Order := strtoint(ListBoxA.items[sel]);

if TagFilter.items[sel] = '-' then exit;  // No label for this tag - dont select

{
if copy(Tag, sel+1, 1) = 'X' then
   begin
   Insert('O', Tag, Sel+1);
   Delete(tag,sel+2,1);

   end
      else
          begin
          Insert('X', Tag, Sel+1);
          Delete(Tag,sel+2,1);
          end;}


if copy(Tag, order, 1) = 'X' then
   begin
   Insert('O', Tag, order);
   Delete(tag,order+1,1);

   end
      else
          begin
          Insert('X', Tag, order);
          Delete(Tag,order+1,1);
          end;

GlobalFilter := Tag;

Label10.caption := copy(Tag, sel+1, 1);

PB.refresh;

if checkbox2.checked then PB.filter := '';  // If Filtering by Tags, show all results


end;


procedure TForm1.FilterDrawItem(Control: TWinControl; Index: Integer;
  Rect: TRect; State: TOwnerDrawState);
var
	Bitmap: TBitmap;      { temporary variable for the item’s bitmap }
	Offset: Integer;      { text offset width }
Tag, Indicator:  String;
X,Y:  integer;
begin
Tag := GlobalFilter;

	with (Control as TListBox).Canvas do  { draw on control canvas, not on the form }
	begin
        Brush.Color := clWhite;
        Font.Color := clBlack;

        X := strtoint(listboxA.items[index]);
        Indicator := copy(Tag, X, 1);

        if (Indicator = 'X') then Font.Color := clBlue;
 //       if FirstDraw = true then         // Trial Line
 //         begin
 //         Font.Color := clBlack;
 //         FirstDrawCount := FirstDrawCount + 1;
 //         if FirstDrawCount > 150 then FirstDraw := false;
 //         end;

        FillRect(Rect);       { clear the rectangle }
	Offset := 2;          { provide default offset }
	Bitmap := TBitmap((Control as TListBox).Items.Objects[Index]);  { get the bitmap }

if Bitmap <> nil then
	begin
		BrushCopy(Bounds(Rect.Left + 2, Rect.Top, Bitmap.Width, Bitmap.Height),
			Bitmap, Bounds(0, 0, Bitmap.Width, Bitmap.Height), clRed);  {render bitmap}
		Offset := Bitmap.width + 6;    { add four pixels between bitmap and text}
	end;
	TextOut(Rect.Left + Offset, Rect.Top, (Control as TListBox).Items[Index])  { display the text }
	end;
end;


procedure TForm1.PBFilterRecord(DataSet: TDataSet; var Accept: Boolean);
var
tag:  string;
Show:  boolean;
X:  integer;
begin
Show := false;
accept := true;
tag := PB.FieldByName('Country').AsString;
if (copy(tag, 1,1) = 'X') and checkbox1.checked then accept := false;  // REJECT ALL ARGO RECORDS IF CHECKED

if Checkbox2.checked = true then // check tags
  begin
  accept := false;
  for x := 1 to 50 do
     if (copy(tag,x,1) = 'X') AND (copy(GlobalFilter, x, 1) = 'X') then accept := true;

  end;





end;

procedure TForm1.CheckBox2Click(Sender: TObject);
begin
PB.refresh;
end;

procedure TForm1.Button30Click(Sender: TObject);
var
X:  integer;
begin
// EDIT TAGS
// TRANSFER STRING GRID UPDATED TAGS BACK TO LISTBOXB

for x := 0 to 49 do
   begin
   listboxB.items[x] := stringgrid1.cells[0, x+1];
   listboxA.items[x] := stringgrid1.cells[1, x+1];
   end;
TagFilter.items := ListboxB.Items;

ListboxB.items.savetofile('tags.txt');
ListboxA.items.savetofile('tagorder.txt');

Form1.width := 990;
end;

procedure TForm1.Button31Click(Sender: TObject);
var
X:  integer;
begin
// EDIT TAGS
// POPULATE STRING GRID WITH TAGS FROM LISTBOXB

for x := 0 to 49 do
   begin
   stringgrid1.cells[0, x+1] := listboxB.items[x];
   stringgrid1.cells[1, x+1] := listboxA.items[x];
   end;
Form1.width := 1520;  //1442;
end;

procedure TForm1.PBAfterScroll(DataSet: TDataSet);
begin
label12.caption := 'Entries Shown: ' + inttostr(PB.recordcount);
end;

procedure TForm1.SpeedButton1Click(Sender: TObject);
var
temp0, temp1:  String;
SelectedRow:  integer;
begin
// MOVE SELECTED ROW UP ONE ROW
SelectedRow := stringgrid1.row;
if (SelectedRow = 1) then exit;  // Cant move lower than 1

// Swap Rows
Temp0 := stringgrid1.cells[0, SelectedRow-1];
Temp1 := stringgrid1.cells[1, SelectedRow-1];

stringgrid1.cells[0, SelectedRow-1] := stringgrid1.cells[0, SelectedRow];
stringgrid1.cells[1, SelectedRow-1] := stringgrid1.cells[1, SelectedRow];


stringgrid1.cells[0, SelectedRow] := Temp0;
stringgrid1.cells[1, SelectedRow] := Temp1;

Stringgrid1.Row := Stringgrid1.Row - 1;
end;

procedure TForm1.SpeedButton2Click(Sender: TObject);
var
temp0, temp1:  String;
SelectedRow:  integer;
begin
// MOVE SELECTED ROW DOWN ONE ROW
SelectedRow := stringgrid1.row;
if (SelectedRow = 50) then exit;  // Cant move past 50

// Swap Rows
Temp0 := stringgrid1.cells[0, SelectedRow+1];
Temp1 := stringgrid1.cells[1, SelectedRow+1];

stringgrid1.cells[0, SelectedRow+1] := stringgrid1.cells[0, SelectedRow];
stringgrid1.cells[1, SelectedRow+1] := stringgrid1.cells[1, SelectedRow];


stringgrid1.cells[0, SelectedRow] := Temp0;
stringgrid1.cells[1, SelectedRow] := Temp1;

Stringgrid1.Row := Stringgrid1.Row + 1;
end;

procedure TForm1.Timer1Timer(Sender: TObject);
var
x:  integer;
begin
for x := 0 to 49 do TagFilter.selected[x] := false;
TagFilter.refresh;
timer1.enabled := false;
end;

procedure TForm1.PBBeforePost(DataSet: TDataSet);
begin
//if DBEdit1.text = 'NAME' then PB.Cancel;
end;

procedure TForm1.Button32Click(Sender: TObject);
begin
if TButton(sender).caption = 'Hide Tags' then
   begin
   Panel2.visible := true;
   Panel3.left := 5;
   TButton(sender).caption := 'Show Tags';
   Form1.width := 640;
   exit;
   end;

   if Tbutton(sender).caption = 'Show Tags' then
   begin
   Panel3.left := 200;
   Panel2.visible := true;
   TButton(sender).caption := 'Hide Tags';
   Form1.width := 990;
   exit;
   end;

end;

procedure TForm1.BackupDatabase;
var
  BackupDir, DateDir, SourceFile, DestFile: string;
  DateString: string;
  i: Integer;
  FilesToCopy: array[0..2] of string;
begin
  PB.Active := false;
  // Set the directory paths
  BackupDir := ExtractFilePath(ParamStr(0)) + 'BackupDB\';
  DateString := FormatDateTime('yyyy-mm-dd', Now); // Format the date as 'yyyy-mm-dd'
  DateDir := BackupDir + 'DB' + DateString + '\';

  // Create the BackupDB folder if it doesn't exist
  if not DirectoryExists(BackupDir) then
    CreateDir(BackupDir);

  // Create the dated subfolder
  if not DirectoryExists(DateDir) then
    CreateDir(DateDir);

  // Define the files to copy
  FilesToCopy[0] := 'PhonebaseBDE.db';
  FilesToCopy[1] := 'PhonebaseBDE.MB';
  FilesToCopy[2] := 'PhonebaseBDE.PX';

  // Copy the files
  for i := 0 to High(FilesToCopy) do
  begin
    SourceFile := ExtractFilePath(ParamStr(0)) + FilesToCopy[i];
    DestFile := DateDir + ExtractFileName(FilesToCopy[i]);
    if FileExists(SourceFile) then
    begin
      if not CopyFile(PChar(SourceFile), PChar(DestFile), False) then
        ShowMessage('Failed to copy ' + FilesToCopy[i]);
    end
    else
      ShowMessage('Source file not found: ' + FilesToCopy[i]);
  end;

  PB.Active := true;

  ShowMessage('Backup completed to ' + DateDir);
end;


end.
